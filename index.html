<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pro Bowling</title>
    <style>
        :root { --gold: #ffd700; --blue: #00eaff; --bg: #050505; --red: #ff3333; }
        body {
            margin: 0; overflow: hidden; background: #111;
            font-family: 'Segoe UI', Roboto, sans-serif;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; color: white; user-select: none;
        }

        #game-container {
            position: relative;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.9);
            border-radius: 4px; overflow: hidden;
            width: 450px; height: 800px;
            background: #000;
        }

        canvas { display: block; width: 100%; height: 100%; }

        /* UI LAYOUTS */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.95); z-index: 200;
            transition: opacity 0.3s;
        }
        .hidden { display: none !important; }

        /* HOME SCREEN */
        h1 { font-size: 40px; color: var(--blue); text-transform: uppercase; margin-bottom: 10px; text-shadow: 0 0 20px var(--blue); }
        .btn-row { display: flex; gap: 20px; margin-top: 40px; }
        .btn {
            padding: 15px 30px; font-size: 18px; font-weight: bold;
            border: 2px solid var(--gold); background: transparent; color: var(--gold);
            cursor: pointer; transition: 0.2s; text-transform: uppercase;
        }
        .btn:hover { background: var(--gold); color: black; box-shadow: 0 0 20px var(--gold); }
        .btn-blue { border-color: var(--blue); color: var(--blue); }
        .btn-blue:hover { background: var(--blue); color: black; box-shadow: 0 0 20px var(--blue); }
        .btn-red { border-color: var(--red); color: var(--red); }
        .btn-red:hover { background: var(--red); color: white; box-shadow: 0 0 20px var(--red); }

        /* IN-GAME HUD */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #top-hud {
            padding: 20px; display: flex; justify-content: space-between; align-items: flex-start;
            background: linear-gradient(rgba(0,0,0,0.8), transparent);
        }
        .score-box { text-align: center; }
        .score-lbl { font-size: 10px; color: #888; font-weight: 700; letter-spacing: 1px; }
        .score-val { font-size: 32px; font-weight: 900; color: white; }

        /* PAUSE BUTTON */
        #pause-btn {
            pointer-events: auto; cursor: pointer;
            position: absolute; top: 100px; right: 10px;
            width: 30px; height: 30px;
            border: 2px solid white; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 18px; z-index: 100;
            background: rgba(0,0,0,0.5);
        }
        #pause-btn:hover { background: white; color: black; }

        /* PAUSE MENU */
        #pause-menu { z-index: 300; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); }
        .menu-title { font-size: 30px; color: white; margin-bottom: 40px; font-weight: 900; }
        .menu-opt {
            font-size: 24px; color: #aaa; margin: 15px 0; cursor: pointer; font-weight: bold;
        }
        .menu-opt:hover { color: white; transform: scale(1.1); }

        /* RESUME PROMPT */
        #resume-modal { z-index: 400; background: #111; border: 2px solid var(--blue); width: 80%; height: auto; top: 30%; left: 10%; border-radius: 10px; padding: 20px; box-sizing: border-box; }

        /* MESSAGE POPUPS */
        #message {
            position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%) scale(0);
            font-size: 70px; font-weight: 900; color: white;
            text-shadow: 0 5px 0 #000, 0 0 30px var(--gold);
            transition: transform 0.2s cubic-bezier(0.3, 2, 0.3, 1);
            white-space: nowrap; z-index: 10; pointer-events: none;
        }
        .pop { transform: translate(-50%, -50%) scale(1) !important; }

        #achieve-pop {
            position: absolute; top: 90px; left: 50%; transform: translateX(-50%) translateY(-200%);
            background: rgba(20, 20, 20, 0.95); border: 1px solid var(--gold);
            padding: 10px 20px; border-radius: 30px; display: flex; align-items: center; gap: 10px;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2); transition: 0.5s; z-index: 500;
        }
        .show-ach { transform: translateX(-50%) translateY(0) !important; }

        /* CONTROLS */
        #controls-area {
            position: absolute; bottom: 0; width: 100%;
            padding: 20px 0 30px 0; background: linear-gradient(transparent, rgba(0,0,0,0.95));
            pointer-events: auto; text-align: center;
        }
        #instruct { color: var(--blue); font-size: 18px; font-weight: bold; margin-bottom: 10px; }
        .bar-wrap {
            width: 280px; height: 20px; background: #222; border: 2px solid #444;
            border-radius: 10px; margin: 8px auto; position: relative; overflow: hidden;
        }
        #power-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #e74c3c, #f1c40f, #2ecc71); }
        #aim-cursor { position: absolute; top: 0; left: 50%; width: 4px; height: 100%; background: #fff; transform: translateX(-50%); }

        /* STATS MODAL */
        #stats-screen { z-index: 250; overflow-y: auto; padding: 40px; box-sizing: border-box; display: none; background: #080808;}
        #stats-screen.open { display: flex; }
        .stat-row { display: flex; justify-content: space-between; width: 100%; max-width: 350px; margin: 8px 0; border-bottom: 1px solid #222; padding-bottom: 5px; }
        .ach-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; max-width: 400px; margin-top: 20px; }
        .ach-item { background: #151515; padding: 10px; border-radius: 6px; border: 1px solid #333; opacity: 0.4; font-size: 14px; }
        .ach-item.unlocked { opacity: 1; border-color: var(--gold); background: #222; }

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
</head>
<body>

<div id="game-container">
    <canvas id="world"></canvas>
    
    <div id="home-screen" class="overlay">
        <h1>Pro Bowling</h1>
        <div style="font-size:14px; color:#666; margin-bottom:30px;">Made By Vewerty Ploik</div>
        <div class="btn-row">
            <button class="btn btn-blue" onclick="startGame(true)">Play</button>
            <button class="btn" onclick="openStats()">Stats</button>
        </div>
    </div>

    <div id="resume-prompt" class="overlay hidden" style="background:rgba(0,0,0,0.8);">
        <div id="resume-modal">
            <h2 style="color:white; margin-top:0;">Resume Game?</h2>
            <div id="resume-info" style="color:#aaa; margin-bottom:20px;">Frame 1 - Score 0</div>
            <div style="display:flex; justify-content:space-between;">
                <button class="btn btn-blue" style="font-size:14px; padding:10px 20px;" onclick="confirmResume(true)">Yes</button>
                <button class="btn btn-red" style="font-size:14px; padding:10px 20px;" onclick="confirmResume(false)">No</button>
            </div>
        </div>
    </div>

    <div id="stats-screen" class="overlay">
        <h2 style="color:var(--gold)">Career Stats</h2>
        <div class="stat-row"><span>Games Played</span><span style="font-weight:bold" id="st-games">0</span></div>
        <div class="stat-row"><span>Average</span><span style="font-weight:bold" id="st-avg">0</span></div>
        <div class="stat-row"><span>Best Score</span><span style="font-weight:bold; color:var(--gold)" id="st-best">0</span></div>
        <div class="stat-row"><span>Strikes</span><span style="font-weight:bold" id="st-strikes">0</span></div>
        
        <h2 style="color:var(--gold); margin-top:30px;">Achievements</h2>
        <div class="ach-grid" id="ach-list"></div>
        
        <button class="btn" style="margin-top:30px;" onclick="closeStats()">Back</button>
    </div>

    <div id="pause-menu" class="overlay hidden">
        <div class="menu-title">PAUSED</div>
        <div class="menu-opt" onclick="togglePause()">RESUME</div>
        <div class="menu-opt" onclick="saveAndExit()">SAVE & EXIT</div>
        <div class="menu-opt" style="color:var(--red)" onclick="exitGame()">EXIT</div>
    </div>

    <div id="ui-layer" class="hidden">
        <div id="top-hud">
            <div class="score-box" style="text-align: left;">
                <div class="score-lbl">FRAME</div>
                <div class="score-val" id="ui-frame">1</div>
            </div>
            
            <div id="pause-btn" onclick="togglePause()">II</div>

            <div class="score-box" style="text-align: right;">
                <div class="score-lbl">SCORE</div>
                <div class="score-val" id="ui-score">0</div>
            </div>
        </div>

        <div id="message">STRIKE!</div>
        <div id="achieve-pop">
            <div style="font-size: 24px;">üèÜ</div>
            <div>
                <div style="font-size: 10px; color: var(--gold); font-weight: bold;"></div>
                <div style="font-size: 14px; font-weight: bold;" id="pop-ach-name"></div>
            </div>
        </div>

        <div id="controls-area">
            <div id="instruct">TAP TO AIM</div>
            <div class="bar-wrap"><div id="aim-cursor"></div></div>
            <div class="bar-wrap"><div id="power-fill"></div></div>
        </div>
    </div>
</div>

<script>
    // --- 1. DATA & SAVING ---
    const CAREER_KEY = 'bowling_career_v2';
    const SAVE_KEY = 'bowling_save_v2';
    
    let career = { games: 0, totalScore: 0, bestScore: 0, strikes: 0, spares: 0, unlocked: [] };
    
    // Game Variables
    let frame = 1, frameShot = 1, score = 0, rolls = [];
    let isPaused = false;
    let isGameActive = false;

    // --- ACHIEVEMENTS ---
    const ACHIEVEMENTS = [
        { id: 'sc_50', t: 'Noob', d: 'Score 50++', c: (s)=>s>=50 },
        { id: 'sc_100', t: 'Rookie Levels', d: 'Score 100+', c: (s)=>s>=100 },
        { id: 'sc_150', t: 'Amateur', d: 'Score 150+', c: (s)=>s>=150 },
        { id: 'sc_200', t: 'Get on my level', d: 'Score 200+', c: (s)=>s>=200 },
        { id: 'sc_250', t: 'Ya can‚Äôt keep up', d: 'Score 250+', c: (s)=>s>=250 },
        { id: 'sc_300', t: 'Someone nerf this guy', d: 'Score 300', c: (s)=>s==300 },
        { id: 'sp_10', t: 'Spare Time', d: '10 Spares', c: (s,d)=>d.spares>=10 },
        { id: 'sp_60', t: 'Spares 4 Days', d: '60 Spares', c: (s,d)=>d.spares>=60 },
        { id: 'sp_250', t: 'Spare Party', d: '250 Spares', c: (s,d)=>d.spares>=250 },
        { id: 'sp_800', t: 'Doctor Spare', d: '800 Spares', c: (s,d)=>d.spares>=800 },
        { id: 'st_5', t: 'Striker', d: '5 Strikes', c: (s,d)=>d.strikes>=5 },
        { id: 'st_25', t: 'Striker 2', d: '25 Strikes', c: (s,d)=>d.strikes>=25 },
        { id: 'st_50', t: 'THE BOWLER STRIKES BACK', d: '50 Strikes', c: (s,d)=>d.strikes>=50 },
        { id: 'st_100', t: 'STRIKE NUMBER 100', d: '100 Strikes', c: (s,d)=>d.strikes>=100 },
        { id: 'st_300', t: 'Your A Wizard, Perry', d: '300 Strikes', c: (s,d)=>d.strikes>=300 },
        { id: 'st_500', t: 'Who‚Äôs Perry?', d: '500 Strikes', c: (s,d)=>d.strikes>=500 },
        { id: 'st_1000', t: '1000 is ez', d: '1000 Strikes', c: (s,d)=>d.strikes>=1000 },
        { id: 'gm_10', t: 'Regular', d: 'Play 10 Games', c: (s,d)=>d.games>=10 },
        { id: 'gm_50', t: 'Bowling Enthusiast', d: 'Play 50 Games', c: (s,d)=>d.games>=50 },
        { id: 'gm_300', t: 'Rest your arm, please', d: 'Play 300 Games', c: (s,d)=>d.games>=300 }
    ];

    function loadCareer() {
        const str = localStorage.getItem(CAREER_KEY);
        if(str) career = JSON.parse(str);
    }
    function saveCareer() { localStorage.setItem(CAREER_KEY, JSON.stringify(career)); }
    
    // Check for achievements
    function checkAch(isEnd=false) {
        let save = false;
        ACHIEVEMENTS.forEach(a => {
            if(!career.unlocked.includes(a.id) && a.c(score, career)) {
                career.unlocked.push(a.id);
                showAch(a.t);
                save = true;
            }
        });
        if(save || isEnd) saveCareer();
    }
    function showAch(title) {
        const el = document.getElementById('achieve-pop');
        document.getElementById('pop-ach-name').innerText =;
        el.classList.add('show-ach');
        setTimeout(()=>el.classList.remove('show-ach'), 3000);
    }

    // --- 2. MENU & NAV ---
    window.onload = function() {
        loadCareer();
        
        // Check for saved game
        const saved = localStorage.getItem(SAVE_KEY);
        if(saved) {
            const s = JSON.parse(saved);
            document.getElementById('resume-info').innerText = `Frame ${s.frame} - Score ${s.score}`;
            document.getElementById('home-screen').classList.add('hidden');
            document.getElementById('resume-prompt').classList.remove('hidden');
        }
    };

    window.confirmResume = function(yes) {
        document.getElementById('resume-prompt').classList.add('hidden');
        if(yes) {
            const saved = JSON.parse(localStorage.getItem(SAVE_KEY));
            restoreGame(saved);
        } else {
            localStorage.removeItem(SAVE_KEY);
            document.getElementById('home-screen').classList.remove('hidden');
        }
    };

    window.startGame = function(reset) {
        document.getElementById('home-screen').classList.add('hidden');
        document.getElementById('ui-layer').classList.remove('hidden');
        isGameActive = true;
        isPaused = false;
        
        if(reset) {
            frame = 1; frameShot = 1; score = 0; rolls = [];
            resetPins();
            readyNextShot();
            updateScoreUI();
        }
        Engine.run(engine); // Ensure engine running
    };

    window.openStats = function() {
        document.getElementById('st-games').innerText = career.games;
        document.getElementById('st-avg').innerText = career.games?Math.floor(career.totalScore/career.games):0;
        document.getElementById('st-best').innerText = career.bestScore;
        document.getElementById('st-strikes').innerText = career.strikes;
        
        const l = document.getElementById('ach-list'); l.innerHTML='';
        ACHIEVEMENTS.forEach(a => {
            const u = career.unlocked.includes(a.id);
            l.innerHTML += `<div class="ach-item ${u?'unlocked':''}"><div>${u?'üèÜ':'üîí'} ${a.t}</div><div style="font-size:10px;color:#888">${a.d}</div></div>`;
        });
        document.getElementById('stats-screen').classList.add('open');
    };
    window.closeStats = function() { document.getElementById('stats-screen').classList.remove('open'); };

    window.togglePause = function() {
        if(!isGameActive) return;
        isPaused = !isPaused;
        const pm = document.getElementById('pause-menu');
        if(isPaused) pm.classList.remove('hidden');
        else pm.classList.add('hidden');
    };

    window.saveAndExit = function() {
        // Save current state
        const saveState = {
            frame: frame,
            frameShot: frameShot,
            score: score,
            rolls: rolls,
            // We don't save exact physics positions, just the "start of shot" state
            // When resuming, it will be at the AIM phase of the current shot
        };
        localStorage.setItem(SAVE_KEY, JSON.stringify(saveState));
        location.reload(); // Simplest way to "Exit" is reload to check save logic
    };

    window.exitGame = function() {
        // Exit without saving
        location.reload();
    };

    function restoreGame(s) {
        frame = s.frame;
        frameShot = s.frameShot;
        score = s.score;
        rolls = s.rolls;
        
        document.getElementById('ui-frame').innerText = frame;
        document.getElementById('ui-score').innerText = score;
        
        document.getElementById('ui-layer').classList.remove('hidden');
        isGameActive = true;
        resetPins(); 
        readyNextShot();
    }

    // --- 3. PHYSICS & GAMEPLAY ---
    const { Engine, Render, Runner, Bodies, Composite, Vector, Body, Events } = Matter;
    const canvas = document.getElementById('world');
    const width = 450, height = 800;
    canvas.width = width; canvas.height = height;
    const ctx = canvas.getContext('2d');

    const engine = Engine.create();
    engine.world.gravity.x = 0; engine.world.gravity.y = 0;
    const runner = Runner.create();
    Runner.run(runner, engine);

    // Constants
    const LANE_X = width/2;
    const PIN_RADIUS = 16;
    const BALL_RADIUS = 28;
    const BALL_DENSITY = 0.08; 
    const PIN_DENSITY = 0.008;

    // Game Objects
    let ball;
    let pins = [];
    
    // States
    const STATE = { AIM: 0, POWER: 1, ROLLING: 2, CLEANUP: 3, OVER: 4 };
    let gameState = STATE.AIM;
    
    // ** SPEED SETTINGS (FAST UI, SLOW BALL) **
    let input = { aim: 0, aimD: 0.045, pwr: 0, pwrD: 4.0 };
    let rollStart = 0;

    // Walls
    const wallOpts = { isStatic: true, render: { visible: false } };
    Composite.add(engine.world, [
        Bodies.rectangle(0, height/2, 20, height, wallOpts),
        Bodies.rectangle(width, height/2, 20, height, wallOpts),
        Bodies.rectangle(width/2, -100, width, 50, wallOpts)
    ]);

    function createBall() {
        if(ball) Composite.remove(engine.world, ball);
        ball = Bodies.circle(LANE_X, height-100, BALL_RADIUS, {
            density: BALL_DENSITY,
            friction: 0.0, 
            frictionAir: 0.002, 
            restitution: 0.1
        });
        Composite.add(engine.world, ball);
    }

    function resetPins() {
        pins.forEach(p => Composite.remove(engine.world, p));
        pins = [];
        
        const startY = 200;
        // ** WIDER SPACING: Was 38, Now 48 **
        // This spreads pins out, making strikes harder (splits more likely)
        const spacing = 48; 
        
        for(let r=0; r<4; r++){
            for(let c=0; c<=r; c++){
                const x = LANE_X + (c - r/2) * spacing;
                const y = startY - (r * spacing * 0.866);
                
                const p = Bodies.circle(x, y, PIN_RADIUS, {
                    density: PIN_DENSITY,
                    friction: 0.2, frictionAir: 0.08, restitution: 0.2,
                    label: 'pin'
                });
                p.og = {x, y}; 
                pins.push(p);
                Composite.add(engine.world, p);
            }
        }
    }

    // --- GAME LOOP ---
    (function render() {
        if(!isPaused && isGameActive) {
            // Manual Engine Update not needed since Runner is used, 
            // but we need to update logic
            
            if(gameState === STATE.AIM) {
                input.aim += input.aimD;
                if(input.aim > 1 || input.aim < -1) input.aimD *= -1;
                document.getElementById('aim-cursor').style.left = ((input.aim+1)/2*100)+'%';
            }
            else if(gameState === STATE.POWER) {
                input.pwr += input.pwrD;
                if(input.pwr > 100 || input.pwr < 0) input.pwrD *= -1;
                document.getElementById('power-fill').style.width = input.pwr + '%';
            }
            else if(gameState === STATE.ROLLING) {
                const t = Date.now() - rollStart;
                const stopped = ball.position.y < 300 && Vector.magnitude(ball.velocity) < 0.05;
                const gone = ball.position.y < -50;
                
                if(t > 10000 || stopped || gone) {
                    processShot();
                }
            }
        }

        // Draw
        ctx.fillStyle = '#111'; ctx.fillRect(0,0,width,height);
        
        // Lane
        const lg = ctx.createLinearGradient(0,0,width,0);
        lg.addColorStop(0, '#000'); lg.addColorStop(0.1, '#111');
        lg.addColorStop(0.2, '#754'); lg.addColorStop(0.5, '#a75');
        lg.addColorStop(0.8, '#754'); lg.addColorStop(0.9, '#111'); lg.addColorStop(1, '#000');
        ctx.fillStyle = lg; ctx.fillRect(15,0,width-30,height);

        // Arrows
        ctx.fillStyle = 'rgba(0,0,0,0.3)';
        [-40, 0, 40].forEach(o => {
            ctx.beginPath(); ctx.moveTo(LANE_X+o, height-250);
            ctx.lineTo(LANE_X+o-5, height-260); ctx.lineTo(LANE_X+o+5, height-260);
            ctx.fill();
        });

        // Pins
        pins.forEach(p => {
            ctx.beginPath(); ctx.arc(p.position.x+3, p.position.y+3, PIN_RADIUS, 0, Math.PI*2);
            ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fill();
            
            ctx.beginPath(); ctx.arc(p.position.x, p.position.y, PIN_RADIUS, 0, Math.PI*2);
            const pg = ctx.createRadialGradient(p.position.x-4,p.position.y-4,2,p.position.x,p.position.y, PIN_RADIUS);
            pg.addColorStop(0, '#fff'); pg.addColorStop(1, '#bbb');
            ctx.fillStyle = pg; ctx.fill();
            
            ctx.beginPath(); ctx.arc(p.position.x, p.position.y, PIN_RADIUS*0.4, 0, Math.PI*2);
            ctx.fillStyle = '#d00'; ctx.fill();
        });

        // Ball
        if(isGameActive && ball && gameState !== STATE.CLEANUP) {
            ctx.beginPath(); ctx.arc(ball.position.x, ball.position.y, BALL_RADIUS, 0, Math.PI*2);
            const bg = ctx.createRadialGradient(ball.position.x-6,ball.position.y-6,3,ball.position.x,ball.position.y, BALL_RADIUS);
            bg.addColorStop(0, '#29f'); bg.addColorStop(1, '#002');
            ctx.fillStyle = bg; ctx.fill();
        }

        // Aim Line
        if(isGameActive && gameState === STATE.AIM && ball) {
            ctx.beginPath();
            const ang = input.aim * 0.4;
            ctx.moveTo(ball.position.x, ball.position.y);
            ctx.lineTo(ball.position.x + Math.sin(ang)*200, ball.position.y - Math.cos(ang)*200);
            ctx.strokeStyle = 'rgba(255,255,255,0.4)'; ctx.lineWidth=2; ctx.setLineDash([5,5]); ctx.stroke(); ctx.setLineDash([]);
        }

        requestAnimationFrame(render);
    })();

    // --- GAME LOGIC ---
    function processShot() {
        gameState = STATE.CLEANUP;
        Composite.remove(engine.world, ball);
        ball = null;

        const survivors = [];
        pins.forEach(p => {
            const d = Vector.magnitude(Vector.sub(p.position, p.og));
            const tilt = Math.abs(Math.sin(p.angle)); 
            const isDown = (d > PIN_RADIUS * 2) || (tilt > 0.4) || (p.position.y < -50) || (p.position.x < 0) || (p.position.x > width);
            if(isDown) Composite.remove(engine.world, p);
            else survivors.push(p);
        });

        const down = 10 - survivors.length;
        pins = survivors;
        pins.forEach(p => { Body.setVelocity(p, {x:0, y:0}); Body.setAngularVelocity(p, 0); Body.setAngle(p, 0); });

        handleFrame(down);
    }

    function handleFrame(down) {
        let val = 0;
        
        // Simplified Logic for Demo Stability
        if(frameShot === 1) {
            val = down;
            rolls.push(val);
            if(val === 10) { 
                msg("STRIKE!", "var(--gold)"); career.strikes++; 
                if(frame < 10) setTimeout(nextFrame, 1500);
                else { frameShot++; resetPins(); setTimeout(readyNextShot, 1500); }
            } else {
                msg(val + " PINS");
                frameShot++; setTimeout(readyNextShot, 1500);
            }
        } 
        else if (frameShot === 2) {
            const prev = rolls[rolls.length-1];
            if(frame < 10) {
                val = down - prev;
                rolls.push(val);
                if(down === 10) { msg("SPARE!", "var(--blue)"); career.spares++; } else msg(val+" PINS");
                setTimeout(nextFrame, 1500);
            } else {
                // 10th frame logic
                const r1 = rolls[rolls.length-1];
                if(r1 === 10) {
                      // Strike in first roll
                      val = down; rolls.push(val);
                      if(val===10) { msg("STRIKE!"); career.strikes++; resetPins(); } else msg(val+" PINS");
                      frameShot++; setTimeout(readyNextShot, 1500);
                } else {
                      val = down - r1; rolls.push(val);
                      if(down===10) { msg("SPARE!"); career.spares++; resetPins(); frameShot++; setTimeout(readyNextShot, 1500); }
                      else endGame();
                }
            }
        }
        else if(frameShot === 3) {
             const r2 = rolls[rolls.length-1];
             const r1 = rolls[rolls.length-2];
             if(r2===10 || (r1!==10 && r1+r2===10)) val = down; else val = down - r2;
             rolls.push(val);
             msg(val===10?"STRIKE!":val+" PINS");
             endGame();
        }
        updateScoreUI();
    }

    function nextFrame() {
        frame++; frameShot = 1;
        document.getElementById('ui-frame').innerText = frame;
        resetPins(); readyNextShot();
    }

    function readyNextShot() {
        createBall();
        input.aim = 0; input.pwr = 0;
        gameState = STATE.AIM;
        document.getElementById('instruct').innerText = "TAP TO AIM";
    }

    function updateScoreUI() {
        score = 0;
        let c = 0;
        for(let f=0; f<10; f++) {
            if(c >= rolls.length) break;
            if(rolls[c] === 10) { score += 10 + (rolls[c+1]||0) + (rolls[c+2]||0); c++; }
            else if((rolls[c]||0) + (rolls[c+1]||0) === 10) { score += 10 + (rolls[c+2]||0); c+=2; }
            else { score += (rolls[c]||0) + (rolls[c+1]||0); c+=2; }
        }
        document.getElementById('ui-score').innerText = score;
        checkAch();
    }

    function endGame() {
        updateScoreUI(); // Force score update first
        msg("GAME OVER");
        gameState = STATE.OVER;
        career.games++;
        career.totalScore += score;
        if(score > career.bestScore) career.bestScore = score;
        localStorage.removeItem(SAVE_KEY); // Clear save on finish
        checkAch(true);
        setTimeout(() => {
            document.getElementById('home-screen').classList.remove('hidden');
            document.getElementById('ui-layer').classList.add('hidden');
            isGameActive = false;
        }, 3000);
    }

    function msg(t, c='white') {
        const m = document.getElementById('message');
        m.innerText = t; m.style.color = c;
        m.classList.add('pop'); setTimeout(()=>m.classList.remove('pop'), 2000);
    }

    // Input Handling
    document.getElementById('game-container').addEventListener('pointerdown', (e) => {
        if(!isGameActive || isPaused) return;
        if(e.target.closest('.btn') || e.target.id === 'pause-btn' || e.target.closest('#pause-menu')) return;
        
        if(gameState === STATE.AIM) {
            gameState = STATE.POWER;
            document.getElementById('instruct').innerText = "TAP FOR POWER";
        }
        else if(gameState === STATE.POWER) {
            gameState = STATE.ROLLING;
            document.getElementById('instruct').innerText = "";
            rollStart = Date.now();
            
            // SLOW BALL LOGIC
            const spd = 6.0 + (input.pwr/100)*11.0; 
            const ang = input.aim * 0.3;
            Body.setVelocity(ball, {x: Math.sin(ang)*spd, y: -Math.cos(ang)*spd});
        }
    });

</script>
</body>
</html>
